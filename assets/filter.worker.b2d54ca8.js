(function(){"use strict";function G(s,n,r){if(n===1&&r===1)return s;const f=s*n,d=(f>5?1200-750*(f-5)/5:1200+600*(5-f)/5)/r;return d<300?11:d<1200?Math.round((11-(d-300)/150)*100)/100:Math.round((5-(d-1200)/120)*100)/100}const J=(s,n)=>s===n||!!s&&!!n&&s.length===n.length&&s.every((r,f)=>r.beatmapId===n[f].beatmapId),D=(s,n)=>s&&n&&typeof s=="object"&&typeof n=="object"?Object.keys(s).length===Object.keys(n).length&&Object.keys(s).every(r=>D(s[r],n[r])):s===n,a={mapsPerMode:{}},v=s=>(s.mods&64)===64,k=s=>(s.mods&256)===256,N=s=>({dt:v(s),ht:k(s),ez:(s.mods&2)===2,hd:(s.mods&8)===8,hr:(s.mods&16)===16,fl:(s.mods&1024)===1024}),c=(s,n,r)=>(!s||r>=s)&&(!n||r<=n);function g(s,n){return s!=="yes"&&s!=="no"||s==="yes"&&n||s==="no"&&!n}function w({filters:s,mode:n,mapsPerMode:r}){var S,W;const f=n&&r[n];if(!f||!s||!n)return null;console.log(s);const{songName:u,calcMode:d,count:j,bpmMax:E,bpmMin:L,ppMax:O,ppMin:P,lengthMax:q,lengthMin:z,diffMax:B,diffMin:F,dt:M,hd:$,hr:y,fl:A,ar:p,cs:l,od:h,hp:m,ranked:H,maniaKeys:I}=s;console.time("filter worker task");const o=[];if(u){const e=u==null?void 0:u.toLowerCase().split(" ");o.push(t=>{const i=`${t.artist} - ${t.title} [${t.version}] ${t.mapsetId} ${t.beatmapId}`.toLowerCase();return e.every(b=>i.includes(b))})}if((E||L)&&o.push((e,t)=>{let i=e.bpm;return t.dt&&(i=e.bpm*1.5),t.ht&&(i=e.bpm*.75),c(L,E,i)}),(O||P)&&o.push(e=>!!e.pp&&c(P,O,e.pp)),(q||z)&&o.push(e=>c(z,q,e.length)),(B||F)&&o.push(e=>c(F,B,e.difficulty)),n==="mania"&&I&&I!=="any"&&o.push(e=>I===e.maniaKeys),M&&M!=="any"&&o.push((e,t)=>g(M,t.dt)&&(M!=="invert"||t.ht)),$&&$!=="any"&&o.push((e,t)=>g($,t.hd)),y&&y!=="any"&&o.push((e,t)=>g(y,t.hr)&&(y!=="invert"||t.ez)),A&&A!=="any"&&o.push((e,t)=>g(A,t.fl)),p&&(p[0]||p[1])&&o.push((e,t)=>{const i=G(e.ar,t.hr?1.4:t.ez?.5:1,t.dt?1.5:t.ht?.75:1);return c(p[0],p[1],i)}),l&&(l[0]||l[1])&&o.push(e=>c(l[0],l[1],e.cs)),h&&(h[0]||h[1])&&o.push(e=>c(h[0],h[1],e.accuracy)),m&&(m[0]||m[1])&&o.push(e=>c(m[0],m[1],e.drain)),H&&H.value>0){const e=Date.now()/1e3/60/60;o.push(t=>(e-t.approvedHoursTimestamp)/24<H.value)}const K=o.length?f.filter(e=>{const t=N(e);return o.every(i=>i(e,t))}):f.slice(),[C,Q]=(W=(S=s.sorting)==null?void 0:S.value)!=null?W:["farmValue","desc"],R=e=>e.bpm*(v(e)?1.5:k(e)?.75:1),T=e=>e.length*(v(e)?.75:k(e)?1.5:1),V={farmValue:d?(e,t)=>t.farmValues[d]-e.farmValues[d]:null,pp:(e,t)=>{var i,b;return((i=t.pp)!=null?i:0)-((b=e.pp)!=null?b:0)},bpm:(e,t)=>R(t)-R(e),length:(e,t)=>T(t)-T(e),difficulty:(e,t)=>t.difficulty-e.difficulty,hoursSinceRanked:(e,t)=>t.approvedHoursTimestamp-e.approvedHoursTimestamp}[C!=null?C:"farmValue"],U=Q==="asc"?-1:1,X=(V?K.sort((e,t)=>V(e,t)*U):K).slice(0,j!=null?j:20);return console.timeEnd("filter worker task"),X}self.onmessage=s=>{const[n,r]=s.data;n==="mode"&&a.mode!==r&&(a.mode=r,self.postMessage(w(a))),n==="maps-mode"&&(J(a.mapsPerMode[r.mode],r.data)||(a.mapsPerMode[r.mode]=r.data,self.postMessage(w(a)))),n==="filters"&&!D(a.filters,r)&&(a.filters=r,self.postMessage(w(a)))}})();
